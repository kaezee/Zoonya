<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoonya Map - World Explorer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: Georgia, 'Times New Roman', serif;
        }

        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .auth-dialog {
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #8B4513;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .auth-dialog h2 {
            color: #D4AF37;
            margin-bottom: 20px;
        }

        .auth-dialog input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(40, 40, 40, 0.9);
            border: 2px solid #8B4513;
            border-radius: 8px;
            color: #D4AF37;
            font-size: 16px;
            box-sizing: border-box;
        }

        .auth-dialog input:focus {
            outline: none;
            border-color: #D4AF37;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .auth-dialog button {
            background: linear-gradient(45deg, #8B4513, #A0522D);
            color: #D4AF37;
            border: 2px solid #D4AF37;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .auth-dialog button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .role-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #8B4513;
            color: #D4AF37;
            font-size: 12px;
            z-index: 1001;
            min-width: 50px;
            text-align: center;
            font-weight: bold;
        }

        .role-indicator.admin {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.2);
        }

        .map-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            cursor: grab;
            background: #00A5D2;
            /* Dark blue vignette effect */
            background: radial-gradient(ellipse at center, #00A5D2 0%, #00A5D2 60%, #003d5c 100%);
        }

        .map-container:active {
            cursor: grabbing;
        }

        .map-bounds {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .map-image {
            position: absolute;
            transition: transform 0.1s ease-out;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            transform-origin: top left;
            top: 0;
            left: 0;
            /* Optimize for large images */
            will-change: transform;
            backface-visibility: hidden;
        }

        .controls {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .marker-upload-container {
            position: fixed;
            top: 20px;
            left: 350px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #8B4513;
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            display: none;
        }

        .marker-upload-container h3 {
            color: #D4AF37;
            margin: 0 0 10px 0;
            font-size: 16px;
        }

        .custom-marker {
            position: absolute;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
            z-index: 500;
            max-width: 40px;
            max-height: 40px;
            filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.6));
        }

        .custom-marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
            filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.9));
        }

        .delete-mode {
            background: rgba(255, 100, 100, 0.8) !important;
            color: white !important;
        }

        .text-label.delete-mode:hover {
            background: rgba(255, 50, 50, 0.9) !important;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .marker-preview {
            width: 30px;
            height: 30px;
            border: 2px solid #8B4513;
            border-radius: 4px;
            margin: 5px 0;
            cursor: pointer;
        }

        .control-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #8B4513;
            color: #D4AF37;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 50px;
            text-align: center;
        }

        .control-btn:hover {
            background: rgba(139, 69, 19, 0.8);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .control-btn.active {
            background: rgba(212, 175, 55, 0.8);
            color: #1a1a1a;
        }

        .control-btn.admin-only {
            border-color: #D4AF37;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .zoom-display {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #8B4513;
            color: #D4AF37;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
        }

        .info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #8B4513;
            border-radius: 12px;
            padding: 20px;
            max-width: 300px;
            z-index: 1000;
        }

        .info-panel h2 {
            color: #D4AF37;
            margin-top: 0;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .auth-dialog input::placeholder {
            color: #888;
            font-style: italic;
        }

        .file-input-container {
            margin-top: 15px;
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: linear-gradient(45deg, #8B4513, #A0522D);
            color: #D4AF37;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 2px solid #D4AF37;
        }

        .file-label:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .file-label.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .region-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #D4AF37, #B8860B);
            border: 3px solid #8B4513;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
            z-index: 500;
        }

        .region-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.9);
        }

        .region-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            color: #D4AF37;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1001;
            border: 1px solid #8B4513;
            transform: translate(-50%, -120%);
        }

        .text-label {
            position: absolute;
            color: #D4AF37;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: auto;
            transform: translate(-50%, -50%);
            z-index: 500;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(0,0,0,0.7);
            white-space: nowrap;
        }

        .text-label.region-label {
            border: none;
            background: none;
            font-size: 18px;
            font-weight: bold;
        }

        .text-input-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #8B4513;
            border-radius: 12px;
            padding: 25px;
            z-index: 2000;
            min-width: 400px;
        }

        .text-input-dialog h3 {
            color: #D4AF37;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .text-input-dialog input,
        .text-input-dialog select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: rgba(40, 40, 40, 0.9);
            border: 2px solid #8B4513;
            border-radius: 6px;
            color: #D4AF37;
            font-size: 14px;
            box-sizing: border-box;
        }

        .text-input-dialog input:focus,
        .text-input-dialog select:focus {
            outline: none;
            border-color: #D4AF37;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .dialog-btn {
            padding: 10px 20px;
            border: 2px solid #8B4513;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .dialog-btn.primary {
            background: linear-gradient(45deg, #8B4513, #A0522D);
            color: #D4AF37;
        }

        .dialog-btn.secondary {
            background: rgba(60, 60, 60, 0.8);
            color: #ccc;
        }

        .dialog-btn:hover {
            transform: scale(1.05);
        }

        .instructions {
            background: rgba(139, 69, 19, 0.2);
            border-left: 4px solid #D4AF37;
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
        }

        .instructions ul {
            margin: 5px 0;
            padding-left: 20px;
        }

        .placeholder-map {
            width: 100%;
            height: 100%;
            background: #00A5D2;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .placeholder-text {
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 3px solid #D4AF37;
            max-width: 400px;
        }

        .placeholder-text h3 {
            color: #D4AF37;
            margin-bottom: 15px;
        }

        .save-data {
            margin-top: 15px;
            padding: 10px;
            background: rgba(139, 69, 19, 0.2);
            border-radius: 6px;
            border: 1px solid #8B4513;
        }

        .save-btn {
            background: linear-gradient(45deg, #228B22, #32CD32);
            color: white;
            border: 2px solid #32CD32;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
            transition: all 0.3s ease;
        }

        .save-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(50, 205, 50, 0.3);
        }

        .logout-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(139, 69, 19, 0.8);
            color: #D4AF37;
            border: 2px solid #8B4513;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(212, 175, 55, 0.8);
            color: #1a1a1a;
        }
    </style>
</head>
<body>
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-dialog">
            <h2>Explore the lands of Zoonya</h2>
            <p>Please enter the phrase:</p>
            <p style="color: #D4AF37; font-weight: bold; font-size: 18px; margin: 15px 0;">
                <strong>[Zoona-unna dua]</strong>
            </p>
            <p style="color: #ccc; font-style: italic; font-size: 14px; margin-top: -10px;">
                <em>(meaning "World home to you")</em>
            </p>
            <input type="text" id="accessKey" placeholder="Zoona-unna dua" maxlength="50">
            <div style="margin-top: 15px;">
                <button onclick="authenticate()">Enter Zoonya</button>
            </div>
        </div>
    </div>

    <div id="roleIndicator" class="role-indicator" style="display: none;">
        Viewer
    </div>

    <div class="map-container" id="mapContainer">
        <div class="placeholder-map" id="placeholderMap">
            <div class="placeholder-text">
                <h3>‚≠ê The World of Zoonya Awaits</h3>
                <p>The ancient map of Zoonya has been loaded from the archives. Explore the mystical realm!</p>
            </div>
        </div>
        <img class="map-image" id="mapImage" style="display: none;" alt="Zoonya World Map">
    </div>

    <div class="info-panel">
        <h2>‚≠ê Zoonya Map</h2>
        <p>Explore the world of Zoonya with interactive zoom and pan controls.</p>
        
        <div class="file-input-container" id="adminControls" style="display: none;">
            <label for="mapFile" class="file-label" id="mapFileLabel">üìÅ Upload New Map</label>
            <input type="file" id="mapFile" class="file-input" accept="image/*">
            <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
                <strong>Note:</strong> Uploaded maps are stored locally in your browser only. 
                To share with others, upload to GitHub repository and update DEFAULT_MAP_URL.
            </div>
        </div>

        <div class="save-data" id="saveControls" style="display: none;">
            <strong>Map Data:</strong><br>
            <button class="save-btn" onclick="saveMapData()">üíæ Save Map</button>
            <button class="save-btn" onclick="loadMapData()">üìÇ Load Map</button>
            <button class="save-btn" onclick="exportData()">üì§ Export</button>
            <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
            <button class="save-btn" onclick="document.getElementById('importFile').click()">üì• Import</button>
            <br>
            <button class="save-btn" onclick="debugStorage()" style="background: #666;">üîç Debug Storage</button>
            <button class="save-btn" onclick="clearStorage()" style="background: #a44;">üóëÔ∏è Clear Storage</button>
            <br>
            <button class="save-btn" onclick="resetToGitHubMap()" style="background: #28a745;">üîÑ Reset to GitHub Map</button>
        </div>

        <div class="instructions">
            <strong>Controls:</strong>
            <ul>
                <li>üñ±Ô∏è Drag to pan around</li>
                <li>üîç Use zoom buttons or scroll wheel</li>
                <li id="markerInstruction" style="display: none;">üñ±Ô∏è Double-click to add region markers</li>
                <li id="textInstruction" style="display: none;">üìù Use 'T' button then click to add text</li>
                <li id="customMarkerInstruction" style="display: none;">üìç Upload PNG markers and click to place</li>
                <li id="deleteInstruction" style="display: none;">‚úÇÔ∏è Use delete mode to remove individual items</li>
                <li>üéØ Hover over markers for tooltips</li>
                <li id="editInstructions" style="display: none;">
                    <li>‚úèÔ∏è Double-click text to edit</li>
                </li>
            </ul>
        </div>
    </div>

    <div class="controls">
        <button class="control-btn" id="zoomIn">+</button>
        <div class="zoom-display" id="zoomDisplay">100%</div>
        <button class="control-btn" id="zoomOut">-</button>
        <button class="control-btn" id="resetView">‚åÇ</button>
        <button class="control-btn admin-only" id="addText" style="display: none;">T</button>
        <button class="control-btn admin-only" id="addMarker" style="display: none;">üìç</button>
        <button class="control-btn admin-only" id="deleteMode" style="display: none;">‚úÇÔ∏è</button>
        <button class="control-btn admin-only" id="clearMarkers" style="display: none;">üóëÔ∏è</button>
    </div>

    <div class="marker-upload-container" id="markerUpload">
        <h3>Custom Markers</h3>
        <input type="file" id="markerFile" accept="image/png,image/svg+xml" multiple style="font-size: 12px; color: #D4AF37;">
        <div id="markerPreviews"></div>
    </div>

    <button class="logout-btn" onclick="logout()" style="display: none;" id="logoutBtn">üö™ Logout</button>

    <script>
        // Configuration - Change these values to customize access
        const CONFIG = {
            ADMIN_KEY: "Zoonya Creator", // Change this to your admin password
            VIEWER_KEY: "Zoona-unna dua",     // Change this to your viewer password
            DEFAULT_MAP_URL: "https://kaezee.github.io/Zoonya/images/Zoonya%20map.png", // Your GitHub-hosted map
            ENABLE_SAVE: true // Set to false to disable save/load features
        };

        class ZoonyaMapViewer {
            constructor() {
                this.container = document.getElementById('mapContainer');
                this.image = document.getElementById('mapImage');
                this.placeholder = document.getElementById('placeholderMap');
                this.zoomDisplay = document.getElementById('zoomDisplay');
                
                this.scale = 1;
                this.translateX = 0;
                this.translateY = 0;
                this.isDragging = false;
                this.lastMouseX = 0;
                this.lastMouseY = 0;
                this.regions = [];
                this.textLabels = [];
                this.customMarkers = [];
                this.markerImages = [];
                this.selectedMarkerImage = null;
                this.textMode = false;
                this.markerMode = false;
                this.deleteMode = false;
                this.userRole = 'viewer';
                
                this.minZoom = 0.2;
                this.maxZoom = 5;
                
                this.initializeEventListeners();
                this.loadDefaultMap();
                this.loadSavedData();
            }

            initializeEventListeners() {
                // File upload (admin only)
                document.getElementById('mapFile').addEventListener('change', (e) => {
                    if (this.userRole === 'admin') {
                        this.loadImage(e.target.files[0]);
                    }
                });

                // Zoom controls
                document.getElementById('zoomIn').addEventListener('click', () => {
                    this.zoom(1.2);
                });

                document.getElementById('zoomOut').addEventListener('click', () => {
                    this.zoom(0.8);
                });

                document.getElementById('resetView').addEventListener('click', () => {
                    this.resetView();
                });

                document.getElementById('clearMarkers').addEventListener('click', () => {
                    if (this.userRole === 'admin') {
                        this.clearAll();
                    }
                });

                document.getElementById('addText').addEventListener('click', () => {
                    if (this.userRole === 'admin') {
                        this.toggleTextMode();
                    }
                });

                document.getElementById('addMarker').addEventListener('click', () => {
                    if (this.userRole === 'admin') {
                        this.toggleMarkerMode();
                    }
                });

                document.getElementById('deleteMode').addEventListener('click', () => {
                    if (this.userRole === 'admin') {
                        this.toggleDeleteMode();
                    }
                });

                // Custom marker upload
                document.getElementById('markerFile').addEventListener('change', (e) => {
                    if (this.userRole === 'admin') {
                        this.loadCustomMarkers(e.target.files);
                    }
                });

                // Mouse events
                this.container.addEventListener('mousedown', (e) => {
                    if (e.target === this.image || e.target === this.container) {
                        this.startDragging(e);
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    this.drag(e);
                });

                document.addEventListener('mouseup', () => {
                    this.stopDragging();
                });

                // Zoom with scroll wheel
                this.container.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    if (this.image.style.display !== 'none') {
                        const rect = this.container.getBoundingClientRect();
                        const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
                        this.zoom(zoomFactor, e.clientX - rect.left, e.clientY - rect.top);
                    }
                });

                // Double-click to add region marker (admin only)
                this.container.addEventListener('dblclick', (e) => {
                    if (this.image.style.display !== 'none' && !this.textMode && this.userRole === 'admin') {
                        e.preventDefault();
                        this.addRegionMarker(e);
                    }
                });

                // Single click for text or markers in respective modes
                this.container.addEventListener('click', (e) => {
                    if (this.image.style.display === 'none') return;
                    
                    // Handle delete mode clicks first
                    if (this.deleteMode && this.userRole === 'admin') {
                        if (e.target.classList.contains('text-label')) {
                            e.stopPropagation();
                            this.deleteTextLabel(e.target);
                            return;
                        } else if (e.target.classList.contains('custom-marker')) {
                            e.stopPropagation();
                            this.deleteCustomMarker(e.target);
                            return;
                        } else if (e.target.classList.contains('region-marker')) {
                            e.stopPropagation();
                            this.deleteRegionMarker(e.target);
                            return;
                        }
                    }
                    
                    // Handle adding new items (only if not clicking on existing items)
                    if (!e.target.classList.contains('control-btn') && 
                        !e.target.classList.contains('region-marker') &&
                        !e.target.classList.contains('text-label') &&
                        !e.target.classList.contains('custom-marker') &&
                        !e.target.classList.contains('region-tooltip')) {
                        
                        if (this.textMode && this.userRole === 'admin') {
                            this.addTextLabel(e);
                        } else if (this.markerMode && this.userRole === 'admin' && this.selectedMarkerImage) {
                            this.addCustomMarker(e);
                        }
                    }
                });

                this.container.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                });

                // Auto-save every 30 seconds (admin only)
                if (CONFIG.ENABLE_SAVE) {
                    setInterval(() => {
                        if (this.userRole === 'admin') {
                            this.autoSave();
                        }
                    }, 30000);
                }
            }

            setUserRole(role) {
                this.userRole = role;
                const roleIndicator = document.getElementById('roleIndicator');
                const adminControls = document.getElementById('adminControls');
                const saveControls = document.getElementById('saveControls');
                const logoutBtn = document.getElementById('logoutBtn');
                
                roleIndicator.style.display = 'block';
                logoutBtn.style.display = 'block';
                
                if (role === 'admin') {
                    roleIndicator.textContent = 'Administrator';
                    roleIndicator.classList.add('admin');
                    adminControls.style.display = 'block';
                    if (CONFIG.ENABLE_SAVE) {
                        saveControls.style.display = 'block';
                    }
                    
                    // Show admin controls
                    document.getElementById('addText').style.display = 'block';
                    document.getElementById('addMarker').style.display = 'block';
                    document.getElementById('deleteMode').style.display = 'block';
                    document.getElementById('clearMarkers').style.display = 'block';
                    document.getElementById('markerInstruction').style.display = 'list-item';
                    document.getElementById('textInstruction').style.display = 'list-item';
                    document.getElementById('customMarkerInstruction').style.display = 'list-item';
                    document.getElementById('deleteInstruction').style.display = 'list-item';
                    document.getElementById('editInstructions').style.display = 'block';
                    document.getElementById('markerUpload').style.display = 'block';
                } else {
                    roleIndicator.textContent = 'Viewer';
                    roleIndicator.classList.remove('admin');
                    adminControls.style.display = 'none';
                    saveControls.style.display = 'none';
                    
                    // Hide admin controls
                    document.getElementById('addText').style.display = 'none';
                    document.getElementById('addMarker').style.display = 'none';
                    document.getElementById('deleteMode').style.display = 'none';
                    document.getElementById('clearMarkers').style.display = 'none';
                    document.getElementById('markerUpload').style.display = 'none';
                    
                    // Hide admin-only instructions
                    document.getElementById('markerInstruction').style.display = 'none';
                    document.getElementById('textInstruction').style.display = 'none';
                    document.getElementById('customMarkerInstruction').style.display = 'none';
                    document.getElementById('deleteInstruction').style.display = 'none';
                    document.getElementById('editInstructions').style.display = 'none';
                }
            }

            loadDefaultMap() {
                if (CONFIG.DEFAULT_MAP_URL && CONFIG.DEFAULT_MAP_URL.trim() && CONFIG.DEFAULT_MAP_URL !== "https://i.imgur.com/placeholder.jpg") {
                    console.log('Loading default map from:', CONFIG.DEFAULT_MAP_URL);
                    this.image.src = CONFIG.DEFAULT_MAP_URL;
                    this.image.onload = () => {
                        this.placeholder.style.display = 'none';
                        this.image.style.display = 'block';
                        setTimeout(() => {
                            this.resetView();
                            this.loadMapDataFromStorage();
                        }, 50);
                    };
                    this.image.onerror = () => {
                        console.log("Default map couldn't load, showing placeholder");
                    };
                } else {
                    console.log('No default map URL configured');
                    // Still try to load saved data even without default map
                    this.loadMapDataFromStorage();
                }
            }

            loadImage(file) {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.image.src = e.target.result;
                    this.image.onload = () => {
                        this.placeholder.style.display = 'none';
                        this.image.style.display = 'block';
                        
                        // For large images, wait longer for full processing
                        const imageSize = this.image.naturalWidth * this.image.naturalHeight;
                        const delay = imageSize > 4000000 ? 200 : 50; // 200ms for large images
                        
                        setTimeout(() => {
                            console.log(`Image loaded: ${this.image.naturalWidth}x${this.image.naturalHeight}`);
                            this.resetView();
                        }, delay);
                        
                        if (this.userRole === 'admin' && CONFIG.ENABLE_SAVE) {
                            this.saveImageData(e.target.result);
                        }
                    };
                };
                reader.readAsDataURL(file);
            }

            startDragging(e) {
                this.isDragging = true;
                this.lastMouseX = e.clientX;
                this.lastMouseY = e.clientY;
                this.container.style.cursor = 'grabbing';
            }

            drag(e) {
                if (!this.isDragging) return;

                const deltaX = e.clientX - this.lastMouseX;
                const deltaY = e.clientY - this.lastMouseY;

                this.translateX += deltaX;
                this.translateY += deltaY;

                // Constrain translation to prevent going too far
                this.constrainTranslation();

                this.updateTransform();

                this.lastMouseX = e.clientX;
                this.lastMouseY = e.clientY;
            }

            stopDragging() {
                this.isDragging = false;
                this.container.style.cursor = this.textMode ? 'crosshair' : 'grab';
            }

            zoom(factor, centerX = null, centerY = null) {
                const newScale = Math.max(this.minZoom, Math.min(this.maxZoom, this.scale * factor));
                
                if (newScale === this.scale) return;

                const rect = this.container.getBoundingClientRect();
                const zoomCenterX = centerX !== null ? centerX : rect.width / 2;
                const zoomCenterY = centerY !== null ? centerY : rect.height / 2;

                // Calculate the point in the image coordinates that we're zooming towards
                const imagePointX = (zoomCenterX - this.translateX) / this.scale;
                const imagePointY = (zoomCenterY - this.translateY) / this.scale;

                // Update scale
                this.scale = newScale;

                // Calculate new translation to keep the zoom point in the same screen position
                this.translateX = zoomCenterX - imagePointX * this.scale;
                this.translateY = zoomCenterY - imagePointY * this.scale;
                
                // Update bounds and constrain
                this.setBounds();
                this.constrainTranslation();
                
                this.updateTransform();
                this.updateZoomDisplay();
            }

            resetView() {
                if (this.image.style.display === 'none') return;
                
                const containerRect = this.container.getBoundingClientRect();
                const imageWidth = this.image.naturalWidth;
                const imageHeight = this.image.naturalHeight;
                
                console.log(`Container: ${containerRect.width}x${containerRect.height}, Image: ${imageWidth}x${imageHeight}`);
                
                // For very large images, use a smaller initial scale
                const maxDimension = Math.max(imageWidth, imageHeight);
                let targetScale;
                
                if (maxDimension > 3000) {
                    // Large image - scale to fit with more margin
                    const scaleX = (containerRect.width * 0.6) / imageWidth;
                    const scaleY = (containerRect.height * 0.6) / imageHeight;
                    targetScale = Math.min(scaleX, scaleY, 0.5);
                } else {
                    // Normal image scaling
                    const scaleX = (containerRect.width * 0.8) / imageWidth;
                    const scaleY = (containerRect.height * 0.8) / imageHeight;
                    targetScale = Math.min(scaleX, scaleY, 1);
                }
                
                this.scale = targetScale;
                
                // Center the image precisely
                this.translateX = (containerRect.width - imageWidth * this.scale) / 2;
                this.translateY = (containerRect.height - imageHeight * this.scale) / 2;
                
                console.log(`Final scale: ${this.scale}, Position: ${this.translateX}, ${this.translateY}`);
                
                // Set bounds for panning
                this.setBounds();
                
                this.updateTransform();
                this.updateZoomDisplay();
            }

            setBounds() {
                const containerRect = this.container.getBoundingClientRect();
                const scaledWidth = this.image.naturalWidth * this.scale;
                const scaledHeight = this.image.naturalHeight * this.scale;
                
                // Calculate maximum translation bounds
                this.maxTranslateX = Math.max(0, (scaledWidth - containerRect.width) / 2 + 100);
                this.maxTranslateY = Math.max(0, (scaledHeight - containerRect.height) / 2 + 100);
                this.minTranslateX = Math.min(0, (containerRect.width - scaledWidth) / 2 - 100);
                this.minTranslateY = Math.min(0, (containerRect.height - scaledHeight) / 2 - 100);
            }

            constrainTranslation() {
                if (!this.maxTranslateX) return;
                
                this.translateX = Math.max(this.minTranslateX, Math.min(this.maxTranslateX, this.translateX));
                this.translateY = Math.max(this.minTranslateY, Math.min(this.maxTranslateY, this.translateY));
            }

            updateTransform() {
                if (this.image.style.display !== 'none') {
                    this.image.style.transform = 
                        `translate(${this.translateX}px, ${this.translateY}px) scale(${this.scale})`;
                }
                
                this.regions.forEach(region => {
                    region.element.style.transform = 
                        `translate(${this.translateX + region.x * this.scale}px, ${this.translateY + region.y * this.scale}px) translate(-50%, -50%)`;
                });

                this.textLabels.forEach(label => {
                    label.element.style.transform = 
                        `translate(${this.translateX + label.x * this.scale}px, ${this.translateY + label.y * this.scale}px) translate(-50%, -50%)`;
                    label.element.style.fontSize = Math.max(10, label.baseSize * this.scale) + 'px';
                });

                // Update custom markers positions
                this.customMarkers.forEach(marker => {
                    marker.element.style.transform = 
                        `translate(${this.translateX + marker.x * this.scale}px, ${this.translateY + marker.y * this.scale}px) translate(-50%, -50%)`;
                    const size = Math.max(20, 40 * this.scale);
                    marker.element.style.maxWidth = size + 'px';
                    marker.element.style.maxHeight = size + 'px';
                });
            }

            updateZoomDisplay() {
                this.zoomDisplay.textContent = Math.round(this.scale * 100) + '%';
            }

            addRegionMarker(e) {
                const rect = this.container.getBoundingClientRect();
                const x = (e.clientX - rect.left - this.translateX) / this.scale;
                const y = (e.clientY - rect.top - this.translateY) / this.scale;

                const regionName = prompt('Enter region/landmark name:');
                if (!regionName) return;
                
                const loreText = prompt('Enter lore/description for this place (optional):') || 'A mysterious place in the world of Zoonya...';

                const marker = document.createElement('div');
                marker.className = 'region-marker';
                marker.style.left = '0px';
                marker.style.top = '0px';

                const tooltip = document.createElement('div');
                tooltip.className = 'region-tooltip';
                tooltip.textContent = regionName;
                marker.appendChild(tooltip);

                marker.addEventListener('click', (e) => {
                    e.stopPropagation();
                    alert(`${regionName}\n\n${loreText}`);
                });

                this.container.appendChild(marker);

                const region = { element: marker, x: x, y: y, name: regionName, lore: loreText };
                this.regions.push(region);

                this.updateTransform();
                if (CONFIG.ENABLE_SAVE) this.autoSave();
            }

            toggleTextMode() {
                this.textMode = !this.textMode;
                const textBtn = document.getElementById('addText');
                if (this.textMode) {
                    textBtn.classList.add('active');
                    this.container.style.cursor = 'crosshair';
                } else {
                    textBtn.classList.remove('active');
                    this.container.style.cursor = 'grab';
                }
            }

            addTextLabel(e) {
                if (e.target.classList.contains('region-marker') || e.target.classList.contains('control-btn')) {
                    return;
                }

                const rect = this.container.getBoundingClientRect();
                const x = (e.clientX - rect.left - this.translateX) / this.scale;
                const y = (e.clientY - rect.top - this.translateY) / this.scale;

                this.showTextDialog(x, y);
            }

            showTextDialog(x, y) {
                const dialog = document.createElement('div');
                dialog.className = 'text-input-dialog';
                dialog.innerHTML = `
                    <h3>Add Zoonya Map Text</h3>
                    <input type="text" id="textInput" placeholder="Enter text..." maxlength="50">
                    <select id="textType">
                        <option value="region">Region/Country Name</option>
                        <option value="landmark">City/Landmark</option>
                        <option value="other">Other Text</option>
                    </select>
                    <select id="textSize">
                        <option value="12">Small (12px)</option>
                        <option value="16" selected>Medium (16px)</option>
                        <option value="20">Large (20px)</option>
                        <option value="24">Extra Large (24px)</option>
                    </select>
                    <select id="textColor">
                        <option value="#D4AF37" selected>Gold</option>
                        <option value="#FF6B6B">Red</option>
                        <option value="#4ECDC4">Teal</option>
                        <option value="#45B7D1">Blue</option>
                        <option value="#96CEB4">Green</option>
                        <option value="#FFEAA7">Yellow</option>
                        <option value="#DDA0DD">Purple</option>
                        <option value="#FFFFFF">White</option>
                    </select>
                    <div class="dialog-buttons">
                        <button class="dialog-btn secondary" id="cancelText">Cancel</button>
                        <button class="dialog-btn primary" id="addTextBtn">Add Text</button>
                    </div>
                `;

                document.body.appendChild(dialog);

                const textInput = document.getElementById('textInput');
                textInput.focus();

                document.getElementById('addTextBtn').addEventListener('click', () => {
                    const text = textInput.value.trim();
                    const textType = document.getElementById('textType').value;
                    if (text) {
                        const size = parseInt(document.getElementById('textSize').value);
                        const color = document.getElementById('textColor').value;
                        this.createTextLabel(x, y, text, size, color, textType);
                    }
                    dialog.remove();
                    this.toggleTextMode();
                });

                document.getElementById('cancelText').addEventListener('click', () => {
                    dialog.remove();
                });

                textInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('addTextBtn').click();
                    }
                });
            }

            createTextLabel(x, y, text, size, color, textType = 'other') {
                const label = document.createElement('div');
                label.className = 'text-label';
                if (textType === 'region') {
                    label.classList.add('region-label');
                }
                label.textContent = text;
                label.style.color = color;
                label.style.fontSize = size + 'px';
                label.style.left = '0px';
                label.style.top = '0px';

                // Only admin can edit/delete with double-click (when not in delete mode)
                if (this.userRole === 'admin') {
                    label.addEventListener('dblclick', (e) => {
                        e.stopPropagation();
                        if (!this.deleteMode) {
                            this.editTextLabel(label, x, y, size, color, textType);
                        }
                    });

                    // Handle delete mode clicks
                    label.addEventListener('click', (e) => {
                        if (this.deleteMode) {
                            e.stopPropagation();
                            this.deleteTextLabel(label);
                        }
                    });
                }

                this.container.appendChild(label);

                const textLabel = { 
                    element: label, 
                    x: x, 
                    y: y, 
                    text: text, 
                    baseSize: size, 
                    color: color,
                    textType: textType
                };
                this.textLabels.push(textLabel);

                this.updateTransform();
                if (CONFIG.ENABLE_SAVE) this.autoSave();
            }

            editTextLabel(labelElement, x, y, currentSize, currentColor) {
                const currentText = labelElement.textContent;
                
                const dialog = document.createElement('div');
                dialog.className = 'text-input-dialog';
                dialog.innerHTML = `
                    <h3>Edit Zoonya Text</h3>
                    <input type="text" id="editTextInput" value="${currentText}" maxlength="50">
                    <select id="editTextSize">
                        <option value="12" ${currentSize === 12 ? 'selected' : ''}>Small (12px)</option>
                        <option value="16" ${currentSize === 16 ? 'selected' : ''}>Medium (16px)</option>
                        <option value="20" ${currentSize === 20 ? 'selected' : ''}>Large (20px)</option>
                        <option value="24" ${currentSize === 24 ? 'selected' : ''}>Extra Large (24px)</option>
                    </select>
                    <select id="editTextColor">
                        <option value="#D4AF37" ${currentColor === '#D4AF37' ? 'selected' : ''}>Gold</option>
                        <option value="#FF6B6B" ${currentColor === '#FF6B6B' ? 'selected' : ''}>Red</option>
                        <option value="#4ECDC4" ${currentColor === '#4ECDC4' ? 'selected' : ''}>Teal</option>
                        <option value="#45B7D1" ${currentColor === '#45B7D1' ? 'selected' : ''}>Blue</option>
                        <option value="#96CEB4" ${currentColor === '#96CEB4' ? 'selected' : ''}>Green</option>
                        <option value="#FFEAA7" ${currentColor === '#FFEAA7' ? 'selected' : ''}>Yellow</option>
                        <option value="#DDA0DD" ${currentColor === '#DDA0DD' ? 'selected' : ''}>Purple</option>
                        <option value="#FFFFFF" ${currentColor === '#FFFFFF' ? 'selected' : ''}>White</option>
                    </select>
                    <div class="dialog-buttons">
                        <button class="dialog-btn secondary" id="cancelEdit">Cancel</button>
                        <button class="dialog-btn primary" id="saveEdit">Save</button>
                    </div>
                `;

                document.body.appendChild(dialog);

                const textInput = document.getElementById('editTextInput');
                textInput.focus();
                textInput.select();

                document.getElementById('saveEdit').addEventListener('click', () => {
                    const newText = textInput.value.trim();
                    if (newText) {
                        const newSize = parseInt(document.getElementById('editTextSize').value);
                        const newColor = document.getElementById('editTextColor').value;
                        
                        labelElement.textContent = newText;
                        labelElement.style.color = newColor;
                        labelElement.style.fontSize = newSize + 'px';
                        
                        const labelData = this.textLabels.find(l => l.element === labelElement);
                        if (labelData) {
                            labelData.text = newText;
                            labelData.baseSize = newSize;
                            labelData.color = newColor;
                        }
                        
                        if (CONFIG.ENABLE_SAVE) this.autoSave();
                    }
                    dialog.remove();
                });

                document.getElementById('cancelEdit').addEventListener('click', () => {
                    dialog.remove();
                });
            }

            clearAll() {
                if (confirm('Are you sure you want to clear all markers and text labels?')) {
                    this.regions.forEach(region => {
                        region.element.remove();
                    });
                    this.regions = [];

                    this.textLabels.forEach(label => {
                        label.element.remove();
                    });
                    this.textLabels = [];
                    
                    if (CONFIG.ENABLE_SAVE) this.autoSave();
                }
            }

            // Save/Load functionality - Enhanced debugging
            saveImageData(imageData) {
                if (CONFIG.ENABLE_SAVE) {
                    try {
                        localStorage.setItem('zoonya_map_image', imageData);
                        localStorage.setItem('zoonya_default_map', imageData);
                        console.log('‚úÖ Image saved to localStorage. Size:', Math.round(imageData.length / 1024), 'KB');
                        return true;
                    } catch (e) {
                        console.error('‚ùå Failed to save image:', e);
                        alert('Failed to save image: ' + e.message);
                        return false;
                    }
                }
                return false;
            }

            testLocalStorage() {
                try {
                    const testKey = 'zoonya_test';
                    const testData = 'test_value_' + Date.now();
                    localStorage.setItem(testKey, testData);
                    const retrieved = localStorage.getItem(testKey);
                    localStorage.removeItem(testKey);
                    
                    if (retrieved === testData) {
                        console.log('‚úÖ localStorage is working');
                        return true;
                    } else {
                        console.error('‚ùå localStorage test failed - data mismatch');
                        return false;
                    }
                } catch (e) {
                    console.error('‚ùå localStorage not available:', e);
                    return false;
                }
            }

            loadSavedData() {
                console.log('üîÑ Starting to load saved data...');
                
                if (!this.testLocalStorage()) {
                    console.log('LocalStorage not available, skipping save/load');
                    this.loadDefaultMap();
                    return;
                }
                
                try {
                    // Try to load saved image first
                    let savedImage = localStorage.getItem('zoonya_map_image');
                    if (!savedImage) {
                        savedImage = localStorage.getItem('zoonya_default_map');
                        console.log('Primary image not found, trying backup');
                    }
                    
                    if (savedImage && savedImage !== "data:," && savedImage.length > 100) {
                        console.log('üì∑ Found saved image, size:', Math.round(savedImage.length / 1024), 'KB');
                        this.image.src = savedImage;
                        this.image.onload = () => {
                            console.log('‚úÖ Saved image loaded successfully');
                            this.placeholder.style.display = 'none';
                            this.image.style.display = 'block';
                            setTimeout(() => {
                                this.resetView();
                                this.loadMapDataFromStorage();
                            }, 100);
                        };
                        this.image.onerror = () => {
                            console.log('‚ùå Saved image failed to load, trying default map');
                            this.loadDefaultMap();
                        };
                    } else {
                        console.log('üì∑ No valid saved image found');
                        this.loadDefaultMap();
                    }
                } catch (e) {
                    console.error('‚ùå Error loading saved data:', e);
                    this.loadDefaultMap();
                }
            }

            loadMapDataFromStorage() {
                try {
                    const savedData = localStorage.getItem('zoonya_map_data');
                    if (savedData) {
                        console.log('üìä Loading map data...');
                        const data = JSON.parse(savedData);
                        console.log('üìä Map data contains:', {
                            regions: data.regions?.length || 0,
                            textLabels: data.textLabels?.length || 0,
                            customMarkers: data.customMarkers?.length || 0,
                            lastSaved: data.lastSaved || 'unknown'
                        });
                        this.loadMapFromData(data);
                    } else {
                        console.log('üìä No saved map data found');
                    }
                } catch (e) {
                    console.error('‚ùå Error loading map data:', e);
                }
            }

            autoSave() {
                if (!CONFIG.ENABLE_SAVE || this.userRole !== 'admin') return;
                
                try {
                    const mapData = {
                        regions: this.regions.map(r => ({
                            x: r.x,
                            y: r.y,
                            name: r.name
                        })),
                        textLabels: this.textLabels.map(l => ({
                            x: l.x,
                            y: l.y,
                            text: l.text,
                            baseSize: l.baseSize,
                            color: l.color
                        })),
                        customMarkers: this.customMarkers.map(m => ({
                            x: m.x,
                            y: m.y,
                            imageData: m.imageData
                        })),
                        markerImages: this.markerImages,
                        scale: this.scale,
                        translateX: this.translateX,
                        translateY: this.translateY,
                        lastSaved: new Date().toISOString()
                    };
                    
                    const dataStr = JSON.stringify(mapData);
                    localStorage.setItem('zoonya_map_data', dataStr);
                    console.log('üíæ Auto-saved map data:', {
                        size: Math.round(dataStr.length / 1024) + 'KB',
                        regions: mapData.regions.length,
                        textLabels: mapData.textLabels.length,
                        customMarkers: mapData.customMarkers.length,
                        time: new Date().toLocaleTimeString()
                    });
                    return true;
                } catch (e) {
                    console.error('‚ùå Auto-save failed:', e);
                    return false;
                }
            }

            loadMapFromData(data) {
                // Clear existing elements (but don't clear arrays yet)
                this.regions.forEach(region => region.element.remove());
                this.textLabels.forEach(label => label.element.remove());
                this.customMarkers.forEach(marker => marker.element.remove());
                
                // Reset arrays
                this.regions = [];
                this.textLabels = [];
                this.customMarkers = [];
                
                // Load marker images first
                if (data.markerImages) {
                    this.markerImages = data.markerImages;
                    // Restore marker previews
                    const previewContainer = document.getElementById('markerPreviews');
                    previewContainer.innerHTML = '';
                    this.markerImages.forEach(markerData => {
                        this.displayMarkerPreview(markerData);
                    });
                }
                
                // Load regions
                if (data.regions) {
                    data.regions.forEach(regionData => {
                        const marker = document.createElement('div');
                        marker.className = 'region-marker';
                        marker.style.left = '0px';
                        marker.style.top = '0px';

                        const tooltip = document.createElement('div');
                        tooltip.className = 'region-tooltip';
                        tooltip.textContent = regionData.name;
                        marker.appendChild(tooltip);

                        marker.addEventListener('click', (e) => {
                            e.stopPropagation();
                            alert(`Region: ${regionData.name}\nWelcome to ${regionData.name} in the world of Zoonya!`);
                        });

                        this.container.appendChild(marker);
                        this.regions.push({
                            element: marker,
                            x: regionData.x,
                            y: regionData.y,
                            name: regionData.name
                        });
                    });
                }
                
                // Load text labels
                if (data.textLabels) {
                    data.textLabels.forEach(labelData => {
                        this.createTextLabel(
                            labelData.x,
                            labelData.y,
                            labelData.text,
                            labelData.baseSize,
                            labelData.color
                        );
                    });
                }
                
                // Load custom markers
                if (data.customMarkers) {
                    data.customMarkers.forEach(markerData => {
                        const markerElement = document.createElement('img');
                        markerElement.src = markerData.imageData.data;
                        markerElement.className = 'custom-marker';
                        markerElement.style.left = '0px';
                        markerElement.style.top = '0px';
                        markerElement.title = markerData.imageData.name;

                        this.container.appendChild(markerElement);

                        this.customMarkers.push({
                            element: markerElement,
                            x: markerData.x,
                            y: markerData.y,
                            imageData: markerData.imageData
                        });
                    });
                }
                
                // Restore view if available
                if (data.scale && this.image.style.display !== 'none') {
                    this.scale = data.scale;
                    this.translateX = data.translateX || 0;
                    this.translateY = data.translateY || 0;
                    this.updateTransform();
                    this.updateZoomDisplay();
                } else {
                    // Just update positions without changing view
                    this.updateTransform();
                }
                
                console.log('Map data loaded successfully');
            }
        }

        // Global functions for authentication and data management
        function authenticate() {
            const key = document.getElementById('accessKey').value.trim().toLowerCase();
            
            if (key === CONFIG.ADMIN_KEY.toLowerCase()) {
                document.getElementById('authOverlay').style.display = 'none';
                window.zoonyaMapViewer.setUserRole('admin');
            } else if (key === CONFIG.VIEWER_KEY.toLowerCase()) {
                document.getElementById('authOverlay').style.display = 'none';
                window.zoonyaMapViewer.setUserRole('viewer');
            } else {
                alert('Invalid phrase. Please try again.');
                document.getElementById('accessKey').value = '';
            }
        }

        function logout() {
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('accessKey').value = '';
            document.getElementById('roleIndicator').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            window.zoonyaMapViewer.setUserRole('viewer');
        }

        function saveMapData() {
            if (window.zoonyaMapViewer.userRole !== 'admin') return;
            
            try {
                const mapData = {
                    regions: window.zoonyaMapViewer.regions.map(r => ({
                        x: r.x,
                        y: r.y,
                        name: r.name
                    })),
                    textLabels: window.zoonyaMapViewer.textLabels.map(l => ({
                        x: l.x,
                        y: l.y,
                        text: l.text,
                        baseSize: l.baseSize,
                        color: l.color
                    })),
                    customMarkers: window.zoonyaMapViewer.customMarkers.map(m => ({
                        x: m.x,
                        y: m.y,
                        imageData: m.imageData
                    })),
                    markerImages: window.zoonyaMapViewer.markerImages,
                    scale: window.zoonyaMapViewer.scale,
                    translateX: window.zoonyaMapViewer.translateX,
                    translateY: window.zoonyaMapViewer.translateY,
                    savedAt: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(mapData);
                localStorage.setItem('zoonya_map_data', dataStr);
                
                // Also save current image for persistence
                if (window.zoonyaMapViewer.image.src) {
                    const success = window.zoonyaMapViewer.saveImageData(window.zoonyaMapViewer.image.src);
                    if (success) {
                        alert(`‚úÖ Map data saved successfully!\nSize: ${Math.round(dataStr.length / 1024)}KB\nRegions: ${mapData.regions.length}\nTexts: ${mapData.textLabels.length}\nMarkers: ${mapData.customMarkers.length}`);
                    } else {
                        alert('‚ö†Ô∏è Map data saved but image save failed. Check console for details.');
                    }
                } else {
                    alert('‚úÖ Map data saved (no image to save)');
                }
            } catch (e) {
                console.error('‚ùå Save failed:', e);
                alert('‚ùå Failed to save: ' + e.message);
            }
        }

        function loadMapData() {
            if (window.zoonyaMapViewer.userRole !== 'admin') return;
            
            try {
                const savedData = localStorage.getItem('zoonya_map_data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    window.zoonyaMapViewer.loadMapFromData(data);
                    alert(`‚úÖ Map data loaded!\nFrom: ${data.savedAt || 'Unknown'}\nRegions: ${data.regions?.length || 0}\nTexts: ${data.textLabels?.length || 0}\nMarkers: ${data.customMarkers?.length || 0}`);
                } else {
                    alert('‚ùå No saved data found.');
                }
            } catch (e) {
                console.error('‚ùå Load failed:', e);
                alert('‚ùå Error loading saved data: ' + e.message);
            }
        }

        function debugStorage() {
            if (window.zoonyaMapViewer.userRole !== 'admin') return;
            
            const mapData = localStorage.getItem('zoonya_map_data');
            const mapImage = localStorage.getItem('zoonya_map_image');
            const defaultMap = localStorage.getItem('zoonya_default_map');
            
            let report = 'üîç STORAGE DEBUG REPORT\n\n';
            report += `Map Data: ${mapData ? Math.round(mapData.length/1024)+'KB' : 'Not found'}\n`;
            report += `Map Image: ${mapImage ? Math.round(mapImage.length/1024)+'KB' : 'Not found'}\n`;
            report += `Default Map: ${defaultMap ? Math.round(defaultMap.length/1024)+'KB' : 'Not found'}\n\n`;
            
            if (mapData) {
                try {
                    const data = JSON.parse(mapData);
                    report += `Regions: ${data.regions?.length || 0}\n`;
                    report += `Text Labels: ${data.textLabels?.length || 0}\n`;
                    report += `Custom Markers: ${data.customMarkers?.length || 0}\n`;
                    report += `Last Saved: ${data.lastSaved || 'Unknown'}\n`;
                } catch (e) {
                    report += `‚ùå Data parsing error: ${e.message}\n`;
                }
            }
            
            // Check localStorage limits
            try {
                let total = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        total += localStorage[key].length;
                    }
                }
                report += `\nTotal localStorage usage: ${Math.round(total/1024)}KB`;
            } catch (e) {
                report += `\n‚ùå Error calculating storage: ${e.message}`;
            }
            
            console.log(report);
            alert(report);
        }

        function resetToGitHubMap() {
            if (window.zoonyaMapViewer.userRole !== 'admin') return;
            
            if (confirm('Reset to the GitHub-hosted Zoonya map? This will replace any locally uploaded map.')) {
                // Clear local image storage
                localStorage.removeItem('zoonya_map_image');
                localStorage.removeItem('zoonya_default_map');
                
                // Force reload from GitHub
                window.zoonyaMapViewer.loadDefaultMap();
                
                alert('‚úÖ Reset to GitHub-hosted map!');
            }
        }

        function clearStorage() {
            if (window.zoonyaMapViewer.userRole !== 'admin') return;
            
            if (confirm('‚ö†Ô∏è This will delete ALL saved map data. Are you sure?')) {
                localStorage.removeItem('zoonya_map_data');
                localStorage.removeItem('zoonya_map_image'); 
                localStorage.removeItem('zoonya_default_map');
                alert('‚úÖ Storage cleared successfully!');
                location.reload();
            }
        }

        function exportData() {
            if (window.zoonyaMapViewer.userRole !== 'admin') return;
            
            const mapData = {
                regions: window.zoonyaMapViewer.regions.map(r => ({
                    x: r.x,
                    y: r.y,
                    name: r.name
                })),
                textLabels: window.zoonyaMapViewer.textLabels.map(l => ({
                    x: l.x,
                    y: l.y,
                    text: l.text,
                    baseSize: l.baseSize,
                    color: l.color
                })),
                scale: window.zoonyaMapViewer.scale,
                translateX: window.zoonyaMapViewer.translateX,
                translateY: window.zoonyaMapViewer.translateY,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(mapData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'zoonya_map_export.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            if (window.zoonyaMapViewer.userRole !== 'admin') return;
            
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        window.zoonyaMapViewer.loadMapFromData(data);
                        alert('Map data imported successfully!');
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Handle Enter key on access key input
        document.getElementById('accessKey').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                authenticate();
            }
        });

        // Initialize the Zoonya map viewer
        window.zoonyaMapViewer = new ZoonyaMapViewer();
    </script>
</body>
</html>
